<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Бриф — HOPE.BY</title>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#667085; --primary:#1e88e5; --border:#e5e7eb; --hint:#f8fafc; }
    *{ box-sizing:border-box }
    body{ font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji","Apple Color Emoji", sans-serif; margin:0; color:var(--fg); background:var(--bg); line-height:1.6; }
    header{ padding:28px 20px; background:linear-gradient(135deg, var(--primary), #1565c0); color:white; position:relative; text-align:center; }
    header h1{ font-size:28px; margin:0 0 6px }
    header .muted{ color:#eaf3ff; font-size:15px }
    .print-btn{ position:absolute; right:20px; top:20px; background:white; color:#1c1c1c; border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; font-size:14px; }
    .print-btn:hover{ background:#f3f4f6 }
    main{ padding:24px 16px; max-width:900px; margin:0 auto; }
    section{ border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:14px; background:#fbfbfb; width:100%; box-shadow:0 2px 10px rgba(0,0,0,0.04); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .field{ flex:1 1 320px; min-width:280px }
    label{ font-weight:700; font-size:15px; display:block; margin-bottom:6px }
    .hint{ font-size:13px; color:var(--muted); margin-top:6px; background:var(--hint); border:1px dashed var(--border); padding:8px 10px; border-radius:8px; }
    input,select,textarea{ width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:white; box-shadow:inset 0 1px 2px rgba(0,0,0,0.03); }
    textarea{ min-height:110px; resize:vertical }
    ::placeholder{ color:#9aa3aa }
    .checkgrid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px 16px }
    .checkitem{ display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; user-select:none; }
    .checkitem input[type="checkbox"]{ width:18px; height:18px; margin:0 }
    .inline-check{ display:flex; align-items:center; gap:10px }
    .inline-check label{ margin:0; font-weight:600; display:flex; align-items:center; gap:8px; cursor:pointer }
    .inline-check input[type="checkbox"]{ width:18px; height:18px; margin:0 }
    .actions{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button.primary{ background:#1e88e5; color:white; border:1px solid #1565c0; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700 }
    button.danger{ background:#d83b3b; color:white; border:1px solid #b22f2f; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700 }
    .msg{ margin-top:12px; padding:12px 14px; border-radius:10px; }
    .ok{ background:#e7f5ff; border:1px solid #b3e0ff; color:#0b3c61 }
    .err{ background:#fde7e7; border:1px solid #f2b2b2; color:#7a1d1d }
    a.link{ color:#1e88e5; word-break: break-word; }
  </style>
</head>
<body>
  <header>
    <h1>Бриф</h1>
    <p id="subtitle" class="muted">Загрузка...</p>
    <button class="print-btn" onclick="window.print()">Печать</button>
  </header>

  <main>
    <section>
      <div class="row">
        <div class="field">
          <label>ID</label>
          <input id="id" type="text" readonly />
        </div>
        <div class="field">
          <label>Создано</label>
          <input id="createdAt" type="text" readonly />
        </div>
        <div class="field">
          <label>Статус</label>
          <select id="status">
            <option value="request_new">Новая заявка</option>
            <option value="in_review">На рассмотрении</option>
            <option value="approved">Одобрено</option>
            <option value="in_progress">В работе</option>
            <option value="done">Готово</option>
            <option value="rejected">Отклонено</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="field">
          <label>Тип задачи</label>
          <select id="taskType">
            <option value="video">Видео</option>
            <option value="design">Дизайн</option>
            <option value="live">Эфир / Стрим</option>
            <option value="translation">Перевод (иностр.)</option>
            <option value="other">Другое</option>
          </select>
        </div>
        <div class="field">
          <label>Дедлайн выполнения</label>
          <input id="deadline" type="datetime-local" />
          <div class="hint">Можно оставить пустым.</div>
        </div>
        <div class="field">
          <label>Тип записи (для видео)</label>
          <select id="recordType">
            <option>Студийная запись</option>
            <option>Выездная — в городе</option>
            <option>Выездная — другие города</option>
          </select>
        </div>
      </div>
    </section>

    <section>
      <div id="sourceTranslation" class="field" style="display:none;">
        <label>Ссылка на источник (оригинал для перевода) *</label>
        <input id="sourceLinkTranslation" type="url" placeholder="https://..." />
        <div class="hint">Обязательное при типе “Перевод”.</div>
      </div>

      <div id="outDesign" class="field" style="margin-top:12px; display:none;">
        <label>Выходной вид (Дизайн)</label>
        <div class="checkgrid">
          <label class="checkitem"><input data-out="design" type="checkbox" value="file"> <span>Файл (рендер)</span></label>
          <label class="checkitem"><input data-out="design" type="checkbox" value="archive"> <span>Архив (проект/исходники)</span></label>
        </div>
      </div>

      <div id="outVideo" class="field" style="margin-top:12px; display:none;">
        <label>Выходной вид (Видео)</label>
        <div class="checkgrid">
          <label class="checkitem"><input data-out="video" type="checkbox" value="file"> <span>Файл (рендер)</span></label>
          <label class="checkitem"><input data-out="video" type="checkbox" value="archive"> <span>Архив (проект/исходники)</span></label>
          <label class="checkitem"><input data-out="video" type="checkbox" value="yt"> <span>Загрузить на YouTube</span></label>
          <label class="checkitem"><input data-out="video" type="checkbox" value="rutube"> <span>Загрузить на Рутуб</span></label>
          <label class="checkitem"><input data-out="video" type="checkbox" value="zen"> <span>Загрузить в Дзен</span></label>
          <label class="checkitem"><input data-out="video" type="checkbox" value="yadisk"> <span>Загрузить на Яндекс.Диск</span></label>
        </div>
      </div>

      <div id="outLive" class="field" style="margin-top:12px; display:none;">
        <label>Платформы эфира</label>
        <div class="checkgrid">
          <label class="checkitem"><input data-out="live" type="checkbox" value="yt"> <span>YouTube</span></label>
          <label class="checkitem"><input data-out="live" type="checkbox" value="tg"> <span>Телеграм</span></label>
          <label class="checkitem"><input data-out="live" type="checkbox" value="vkvideo"> <span>ВК Видео</span></label>
        </div>
      </div>
    </section>

    <section>
      <div class="row">
        <div class="field">
          <label>Ключевое сообщение / Краткое ТЗ</label>
          <textarea id="keyMessage" placeholder="Основная идея, требования и ограничения..."></textarea>
        </div>
        <div class="field">
          <label>Заметки</label>
          <textarea id="notes" placeholder="Внутренние пометки"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="field">
          <label>Ссылка на материалы</label>
          <input id="materialsLink" type="url" placeholder="https://..." />
          <div id="materialsLinkView" class="hint" style="margin-top:6px;"></div>
        </div>
        <div class="field">
          <label>Референс / источник</label>
          <input id="sourceLink" type="url" placeholder="https://..." />
          <div id="sourceLinkView" class="hint" style="margin-top:6px;"></div>
        </div>
      </div>
    </section>

    <section>
      <div class="row">
        <div class="field">
          <label>Имя заявителя</label>
          <input id="requesterName" type="text" />
        </div>
        <div class="field">
          <label>Telegram заявителя</label>
          <input id="requesterTelegram" type="text" />
        </div>
        <div class="field">
          <label>Email заявителя</label>
          <input id="requesterEmail" type="email" />
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <a id="contactTg" class="primary" style="text-decoration:none; padding:10px 14px; border-radius:10px; background:#1e88e5; color:#fff" target="_blank">Связаться в Telegram</a>
        <a id="contactMail" class="primary" style="text-decoration:none; padding:10px 14px; border-radius:10px; background:#1e88e5; color:#fff" target="_blank">Написать Email</a>
      </div>
    </section>

    <section>
      <div class="row">
        <div class="field">
          <label>Уведомления</label>
          <div class="inline-check">
            <label><input type="checkbox" id="sendTelegram"> <span>Отправлять в Telegram</span></label>
            <input id="telegramContact" type="text" placeholder="@username или chat_id" />
          </div>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="inline-check">
            <label><input type="checkbox" id="sendEmail"> <span>Отправлять на Email</span></label>
            <input id="emailContact" type="email" placeholder="email получателя" />
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="actions">
        <button id="saveBtn" class="primary">Сохранить изменения</button>
        <button id="rejectBtn" class="danger">Отклонить заявку</button>
        <a id="openRequest" class="primary" style="text-decoration:none" href="./request.html" target="_blank">Создать новую</a>
      </div>
      <div id="saveMsg"></div>
    </section>
  </main>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx0CuIfGvp8RTCvBOOp8IxbCfxzDyxmfHz9j8uiRCM7MJkd5tJAgfZtqoo7O2UHkJDUew/exec';

    const qs = new URLSearchParams(location.search);
    const id = qs.get('id');

    const el = (id)=>document.getElementById(id);
    const show = (node,on)=> node.style.display = on ? '' : 'none';

    const sections = {
      outDesign: el('outDesign'),
      outVideo: el('outVideo'),
      outLive: el('outLive'),
      sourceTranslation: el('sourceTranslation')
    };

    function setLinkView(inputId, viewId){
      const v = el(inputId).value.trim();
      el(viewId).innerHTML = v ? ('Ссылка: <a class="link" href="'+v+'" target="_blank">'+v+'</a>') : '—';
    }

    function getCheckedValuesByType(type){
      return [...document.querySelectorAll('input[data-out="'+type+'"]')].filter(i=>i.checked).map(i=>i.value);
    }

    function setCheckedValuesByType(type, values){
      const set = new Set(values||[]);
      document.querySelectorAll('input[data-out="'+type+'"]').forEach(i=> i.checked = set.has(i.value));
    }

    function updateVisibilityByType(t){
      show(sections.outDesign, t==='design');
      show(sections.outVideo, t==='video');
      show(sections.outLive, t==='live');
      show(sections.sourceTranslation, t==='translation');
    }

    async function loadCard(){
      if (!id) { el('subtitle').textContent = 'Нет параметра id'; return; }
      el('subtitle').textContent = 'Загрузка #' + id + '...';
      try{
        const res = await fetch(API_URL + '?id=' + encodeURIComponent(id));
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Ошибка загрузки');
        const d = json.data;

        // Базовые поля
        ['id','createdAt','status','taskType','deadline','recordType','keyMessage','notes','materialsLink','sourceLink','requesterName','requesterTelegram','requesterEmail','telegramContact','emailContact']
          .forEach(f=>{ if (el(f)) el(f).value = d[f] ?? ''; });

        // Уведомления
        el('sendTelegram').checked = String(d.sendTelegram).toLowerCase()==='true';
        el('sendEmail').checked = String(d.sendEmail).toLowerCase()==='true';

        // Типозависимые секции и выходы
        updateVisibilityByType(d.taskType || 'design');
        setCheckedValuesByType('design', d.taskType==='design' ? (d.outputOptions||[]) : []);
        setCheckedValuesByType('video', d.taskType==='video' ? (d.outputOptions||[]) : []);
        setCheckedValuesByType('live', d.taskType==='live' ? (d.outputOptions||[]) : []);

        // Перевод — источник
        if (d.taskType==='translation'){
          el('sourceLinkTranslation').value = d.sourceLink || '';
        }

        // Линки
        setLinkView('materialsLink','materialsLinkView');
        setLinkView('sourceLink','sourceLinkView');

        // Контакты кнопок
        const tg = d.requesterTelegram || '';
        el('contactTg').href = tg ? ('https://t.me/' + tg.replace('@','')) : 'https://t.me/';
        const mail = d.requesterEmail || '';
        el('contactMail').href = mail ? ('mailto:' + mail) : 'mailto:';

        el('subtitle').textContent = (d.taskType || '') + (d.deadline ? (' • ' + d.deadline) : '');
      }catch(err){
        el('subtitle').textContent = 'Ошибка: ' + String(err.message || err);
        el('saveMsg').innerHTML = '<div class="msg err">Не удалось загрузить карточку: '+String(err.message || err)+'</div>';
      }
    }

    async function saveChanges(){
      // Валидация перевода
      if (el('taskType').value==='translation' && !el('sourceLinkTranslation').value.trim()){
        el('saveMsg').innerHTML = '<div class="msg err">Для типа "Перевод" требуется ссылка на источник.</div>';
        return;
      }

      // Выходные опции
      let outputOptions = [];
      const t = el('taskType').value;
      if (t==='design') outputOptions = getCheckedValuesByType('design');
      if (t==='video') outputOptions = getCheckedValuesByType('video');
      if (t==='live') outputOptions = getCheckedValuesByType('live');

      const payload = {
        action: 'update',
        data: {
          id,
          status: el('status').value,
          taskType: el('taskType').value,
          deadline: el('deadline').value,
          recordType: el('recordType').value || '',
          keyMessage: el('keyMessage').value,
          notes: el('notes').value,
          materialsLink: el('materialsLink').value,
          sourceLink: el('taskType').value==='translation' ? el('sourceLinkTranslation').value : el('sourceLink').value,
          requesterName: el('requesterName').value,
          requesterTelegram: el('requesterTelegram').value,
          requesterEmail: el('requesterEmail').value,
          sendTelegram: el('sendTelegram').checked,
          telegramContact: el('telegramContact').value,
          sendEmail: el('sendEmail').checked,
          emailContact: el('emailContact').value,
          outputOptions
        }
      };

      const btn = el('saveBtn');
      btn.disabled = true;
      el('saveMsg').innerHTML = '';

      try{
        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Ошибка сохранения');
        el('saveMsg').innerHTML = '<div class="msg ok">Сохранено. ID: '+json.id+'</div>';
        setLinkView('materialsLink','materialsLinkView');
        setLinkView('sourceLink','sourceLinkView');
      }catch(err){
        el('saveMsg').innerHTML = '<div class="msg err">Не удалось сохранить: '+String(err.message || err)+'</div>';
      }finally{
        btn.disabled = false;
      }
    }

    async function rejectCard(){
      const ok = confirm('Отклонить заявку? Статус будет "rejected".');
      if (!ok) return;
      el('status').value = 'rejected';
      await saveChanges();
    }

    // events
    document.addEventListener('DOMContentLoaded', loadCard);
    el('materialsLink').addEventListener('input', ()=> setLinkView('materialsLink','materialsLinkView'));
    el('sourceLink').addEventListener('input', ()=> setLinkView('sourceLink','sourceLinkView'));
    el('taskType').addEventListener('change', (e)=> updateVisibilityByType(e.target.value));
    el('saveBtn').addEventListener('click', (e)=>{ e.preventDefault(); saveChanges(); });
    el('rejectBtn').addEventListener('click', (e)=>{ e.preventDefault(); rejectCard(); });
  </script>
</body>
</html>
