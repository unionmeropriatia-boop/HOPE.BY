<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Briefs — список заявок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fff; }
    .card h3 { margin: 0 0 8px; font-size: 18px; }
    .meta { color: #555; font-size: 14px; margin-bottom: 8px; }
    .desc { font-size: 15px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
    input[type="search"] { flex: 1; padding: 8px; }
    .status { margin-bottom: 12px; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>Список заявок</h1>

  <div class="toolbar">
    <input type="search" id="q" placeholder="Поиск по названию/организатору/месту..." />
    <button id="reload">Обновить</button>
  </div>
  <div class="status" id="status"></div>
  <div class="grid" id="grid"></div>

  <script>
    const BASE_API_URL = "";

    const statusEl = document.getElementById("status");
    const gridEl = document.getElementById("grid");
    const qEl = document.getElementById("q");
    const reloadBtn = document.getElementById("reload");

    function setStatus(html, cls = "") {
      statusEl.className = cls;
      statusEl.innerHTML = html;
    }

    function renderCards(items) {
      gridEl.innerHTML = "";
      if (!items?.length) {
        gridEl.innerHTML = "<p>Нет записей.</p>";
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((it) => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <h3>${escapeHTML(it.title || "Без названия")}</h3>
          <div class="meta">
            ${escapeHTML(it.datetime || "")} • ${escapeHTML(it.place || "")}<br/>
            Организатор: ${escapeHTML(it.organizer || "")} • Контакты: ${escapeHTML(it.contacts || "")}
          </div>
          <div class="desc">${escapeHTML(it.description || "")}</div>
        `;
        frag.appendChild(el);
      });
      gridEl.appendChild(frag);
    }

    function escapeHTML(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadBriefs() {
      setStatus("Загрузка...", "");
      try {
        const resp = await fetch(`${BASE_API_URL}/briefs`, { method: "GET" });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`Ошибка API: ${resp.status} ${text}`);
        }
        const data = await resp.json();
        let items = Array.isArray(data) ? data : (data.items || data.results || []);
        const q = qEl.value.trim().toLowerCase();
        if (q) {
          items = items.filter((it) =>
            [it.title, it.organizer, it.place, it.description]
              .filter(Boolean)
              .some((v) => String(v).toLowerCase().includes(q))
          );
        }
        renderCards(items);
        setStatus("", "");
      } catch (err) {
        console.error(err);
        setStatus(`Не удалось загрузить список. ${err.message}`, "error");
      }
    }

    qEl.addEventListener("input", () => loadBriefs());
    reloadBtn.addEventListener("click", () => loadBriefs());

    loadBriefs();
  </script>
</body>
</html>
