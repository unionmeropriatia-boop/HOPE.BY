<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Создать заявку — HOPE.BY</title>
  <style>
    :root{ --bg:#ffffff; --fg:#111; --muted:#667085; --primary:#1e88e5; --border:#e5e7eb; --hint:#f8fafc; }
    *{ box-sizing:border-box }
    body{ font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji","Apple Color Emoji", sans-serif; margin:0; color:var(--fg); background:var(--bg); line-height:1.6; }
    header{ padding:28px 20px; background:linear-gradient(135deg, var(--primary), #1565c0); color:white; text-align:center; }
    header h1{ font-size:28px; margin:0 0 6px }
    header .muted{ color:#eaf3ff; font-size:15px }
    main{ padding:24px 16px; max-width:900px; margin:0 auto; }
    section{ border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:14px; background:#fbfbfb; width:100%; box-shadow:0 2px 10px rgba(0,0,0,0.04); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .field{ flex:1 1 320px; min-width:280px }
    label{ font-weight:700; font-size:15px; display:block; margin-bottom:6px }
    .hint{ font-size:13px; color:var(--muted); margin-top:6px; background:var(--hint); border:1px dashed var(--border); padding:8px 10px; border-radius:8px; }
    input,select,textarea{ width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:white; box-shadow:inset 0 1px 2px rgba(0,0,0,0.03); }
    textarea{ min-height:110px; resize:vertical }
    ::placeholder{ color:#9aa3aa }
    .checkgrid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px 16px }
    .checkitem{ display:flex; align-items:center; gap:8px; font-weight:600; cursor:pointer; user-select:none; }
    .checkitem input[type="checkbox"]{ width:18px; height:18px; margin:0 }
    .inline-check{ display:flex; align-items:center; gap:10px }
    .inline-check label{ margin:0; font-weight:600; display:flex; align-items:center; gap:8px; cursor:pointer }
    .inline-check input[type="checkbox"]{ width:18px; height:18px; margin:0 }
    .actions{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button.primary{ background:#1e88e5; color:white; border:1px solid #1565c0; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:700 }
    button.primary:disabled{ opacity:.6; cursor:not-allowed }
    .msg{ margin-top:12px; padding:12px 14px; border-radius:10px; }
    .ok{ background:#e7f5ff; border:1px solid #b3e0ff; color:#0b3c61 }
    .err{ background:#fde7e7; border:1px solid #f2b2b2; color:#7a1d1d }
  </style>
</head>
<body>
  <header>
    <h1>Заявка</h1>
    <p class="muted">Шаг 1. Заполните форму — создастся карточка брифа.</p>
  </header>
  <main>
    <form id="form">
      <section>
        <div class="row">
          <div class="field">
            <label>Тип задачи</label>
            <select id="taskType" required>
              <option value="">— Выберите —</option>
              <option value="video">Видео</option>
              <option value="design">Дизайн</option>
              <option value="live">Эфир / Стрим</option>
              <option value="translation">Перевод (иностр.)</option>
              <option value="other">Другое</option>
            </select>
            <div class="hint">Ниже появятся релевантные опции.</div>
          </div>
          <div class="field">
            <label>Дедлайн выполнения</label>
            <input id="deadline" type="datetime-local" />
            <div class="hint">Можно оставить пустым.</div>
          </div>
        </div>

        <div id="sourceTranslation" class="field" style="display:none; margin-top:12px;">
          <label>Ссылка на источник (оригинал для перевода) *</label>
          <input id="sourceLinkTranslation" type="url" placeholder="https://..." />
          <div class="hint">Обязательное поле для задачи “Перевод”.</div>
        </div>

        <div id="outDesign" class="field" style="margin-top:12px; display:none;">
          <label>Выходной вид (Дизайн)</label>
          <div class="checkgrid">
            <label class="checkitem"><input type="checkbox" value="file"> <span>Файл (рендер)</span></label>
            <label class="checkitem"><input type="checkbox" value="archive"> <span>Архив (проект/исходники)</span></label>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Отправить: Телеграм</label>
              <div class="inline-check">
                <label><input type="checkbox" id="sendTgDesign"> <span>Телеграм</span></label>
                <input type="text" id="tgHandleDesign" placeholder="@username или телефон" />
              </div>
            </div>
            <div class="field">
              <label>Отправить: Email</label>
              <div class="inline-check">
                <label><input type="checkbox" id="sendEmailDesign"> <span>Email</span></label>
                <input type="email" id="emailDesign" placeholder="name@example.com" />
              </div>
            </div>
          </div>
        </div>

        <div id="outVideo" class="field" style="margin-top:12px; display:none;">
          <label>Выходной вид (Видео)</label>
          <div class="checkgrid">
            <label class="checkitem"><input type="checkbox" value="file"> <span>Файл (рендер)</span></label>
            <label class="checkitem"><input type="checkbox" value="archive"> <span>Архив (проект/исходники)</span></label>
            <label class="checkitem"><input type="checkbox" value="yt"> <span>Загрузить на YouTube</span></label>
            <label class="checkitem"><input type="checkbox" value="rutube"> <span>Загрузить на Рутуб</span></label>
            <label class="checkitem"><input type="checkbox" value="zen"> <span>Загрузить в Дзен</span></label>
            <label class="checkitem"><input type="checkbox" value="yadisk"> <span>Загрузить на Яндекс.Диск</span></label>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Отправить: Телеграм</label>
              <div class="inline-check">
                <label><input type="checkbox" id="sendTgVideo"> <span>Телеграм</span></label>
                <input type="text" id="tgHandleVideo" placeholder="@username или телефон" />
              </div>
            </div>
            <div class="field">
              <label>Отправить: Email</label>
              <div class="inline-check">
                <label><input type="checkbox" id="sendEmailVideo"> <span>Email</span></label>
                <input type="email" id="emailVideo" placeholder="name@example.com" />
              </div>
            </div>
          </div>
        </div>

        <div id="outLive" class="field" style="margin-top:12px; display:none;">
          <label>Платформы эфира</label>
          <div class="checkgrid">
            <label class="checkitem"><input type="checkbox" value="yt"> <span>YouTube</span></label>
            <label class="checkitem"><input type="checkbox" value="tg"> <span>Телеграм</span></label>
            <label class="checkitem"><input type="checkbox" value="vkvideo"> <span>ВК Видео</span></label>
          </div>
        </div>

        <div id="recordTypeWrap" class="field" style="display:none; margin-top:12px">
          <label>Тип записи (для видео)</label>
          <select id="recordType">
            <option>Студийная запись</option>
            <option>Выездная — в городе</option>
            <option>Выездная — другие города</option>
          </select>
          <div class="hint">Выездная запись требует больше времени и состава команды.</div>
        </div>
      </section>

      <section>
        <div class="row">
          <div class="field">
            <label>Ключевое сообщение / Краткое ТЗ</label>
            <textarea id="keyMessage" placeholder="Основная идея, требования и ограничения..."></textarea>
          </div>
          <div class="field">
            <label>Заметки</label>
            <textarea id="notes" placeholder="Дополнительные комментарии"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label>Ссылка на материалы</label>
            <input id="materialsLink" type="url" placeholder="https://..." />
          </div>
          <div class="field">
            <label>Референс / источник</label>
            <input id="sourceLink" type="url" placeholder="https://..." />
          </div>
        </div>
      </section>

      <section>
        <div class="row">
          <div class="field">
            <label>Имя заявителя</label>
            <input id="requesterName" type="text" placeholder="Ваше имя" />
          </div>
          <div class="field">
            <label>Telegram заявителя</label>
            <input id="requesterTelegram" type="text" placeholder="@username" />
          </div>
          <div class="field">
            <label>Email заявителя</label>
            <input id="requesterEmail" type="email" placeholder="you@example.com" />
          </div>
        </div>
      </section>

      <section>
        <div class="row">
          <div class="field">
            <label>Уведомления</label>
            <div class="inline-check">
              <label><input type="checkbox" id="sendTelegram"> <span>Отправить в Telegram</span></label>
              <input id="telegramContact" type="text" placeholder="@username или chat_id" />
            </div>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="inline-check">
              <label><input type="checkbox" id="sendEmail"> <span>Отправить на Email</span></label>
              <input id="emailContact" type="email" placeholder="email получателя" />
            </div>
          </div>
        </div>
      </section>

      <div class="actions">
        <button id="submitBtn" class="primary" type="submit">Отправить заявку</button>
        <span id="status" class="muted"></span>
      </div>
      <div id="result"></div>
    </form>
  </main>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx0CuIfGvp8RTCvBOOp8IxbCfxzDyxmfHz9j8uiRCM7MJkd5tJAgfZtqoo7O2UHkJDUew/exec';

    const el = (id)=>document.getElementById(id);
    const show = (node, on)=> node.style.display = on ? '' : 'none';
    const getCheckedValues = (container)=> [...container.querySelectorAll('input[type="checkbox"]')]
        .filter(i=>i.checked).map(i=>i.value);

    const taskTypeEl = el('taskType');
    const sections = {
      outDesign: el('outDesign'),
      outVideo: el('outVideo'),
      outLive: el('outLive'),
      recordTypeWrap: el('recordTypeWrap'),
      sourceTranslation: el('sourceTranslation')
    };

    function updateVisibility(){
      const t = taskTypeEl.value;
      show(sections.outDesign, t==='design');
      show(sections.outVideo, t==='video');
      show(sections.outLive, t==='live');
      show(sections.recordTypeWrap, t==='video');
      show(sections.sourceTranslation, t==='translation');
    }

    taskTypeEl.addEventListener('change', updateVisibility);
    document.addEventListener('DOMContentLoaded', updateVisibility);

    async function handleSubmit(e){
      e.preventDefault();
      el('submitBtn').disabled = true;
      el('result').innerHTML = '';
      el('status').textContent = 'Отправка...';

      // Сбор выходных опций по типу
      let outputOptions = [];
      if (taskTypeEl.value === 'design') outputOptions = getCheckedValues(sections.outDesign);
      if (taskTypeEl.value === 'video') outputOptions = getCheckedValues(sections.outVideo);
      if (taskTypeEl.value === 'live') outputOptions = getCheckedValues(sections.outLive);

      // Валидация для перевода
      if (taskTypeEl.value === 'translation') {
        const src = el('sourceLinkTranslation').value.trim();
        if (!src) {
          el('result').innerHTML = '<div class="msg err">Для типа "Перевод" требуется ссылка на источник.</div>';
          el('submitBtn').disabled = false;
          el('status').textContent = '';
          return;
        }
      }

      const payload = {
        action: 'create',
        data: {
          mode: 'request',
          status: 'request_new',
          taskType: taskTypeEl.value,
          deadline: el('deadline').value,
          recordType: el('recordType').value || '',
          outputOptions,
          sendTelegram: el('sendTelegram').checked,
          telegramContact: el('telegramContact').value,
          sendEmail: el('sendEmail').checked,
          emailContact: el('emailContact').value,
          sourceLink: el('sourceLink').value || el('sourceLinkTranslation').value || '',
          keyMessage: el('keyMessage').value,
          materialsLink: el('materialsLink').value,
          approver: '',
          notes: el('notes').value,
          requesterName: el('requesterName').value,
          requesterTelegram: el('requesterTelegram').value,
          requesterEmail: el('requesterEmail').value
        }
      };

      try{
        const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Ошибка сервера');

        const briefUrl = json.briefUrl || (`./brief.html?id=${encodeURIComponent(json.id)}`);
        el('result').innerHTML = `<div class="msg ok">Заявка отправлена. ID: <b>${json.id}</b><br><a href="${briefUrl}" target="_blank">Открыть бриф</a></div>`;
      }catch(err){
        el('result').innerHTML = `<div class="msg err">Не удалось отправить заявку: ${String(err.message || err)}</div>`;
      }finally{
        el('submitBtn').disabled = false;
        el('status').textContent = '';
      }
    }

    el('form').addEventListener('submit', handleSubmit);
  </script>
</body>
</html>
