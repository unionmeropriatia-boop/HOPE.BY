
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Заявка — HOPE.BY</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0b0c; color: #e9eaed; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 24px 16px 64px; }
    h1 { font-size: 24px; margin: 16px 0 8px; }
    p.muted { color: #9aa0a6; margin: 0 0 24px; }
    form { display: grid; gap: 16px; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }
    label { font-size: 13px; color: #cbd1d8; display: block; margin-bottom: 6px; }
    input[type="text"], input[type="email"], input[type="url"], input[type="datetime-local"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #2b2f36; background: #0f1114; color: #e9eaed;
      outline: none; transition: border .2s;
    }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus { border-color: #3b82f6; }
    .hint { font-size: 12px; color: #9aa0a6; margin-top: 6px; }
    .switch { display: flex; align-items: center; gap: 12px; }
    .switch input { transform: scale(1.2); }
    .actions { display: flex; gap: 12px; align-items: center; }
    button.primary {
      background: #3b82f6; color: white; border: none; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-weight: 600;
    }
    button.primary:disabled { opacity: .6; cursor: not-allowed; }
    .msg { margin-top: 20px; padding: 14px 16px; border-radius: 10px; }
    .ok { background: #062e12; color: #b7f7cb; border: 1px solid #195a2b; }
    .err { background: #2a0b0b; color: #ffc3c3; border: 1px solid #6b2626; }
    a { color: #7fb3ff; }
    .card { background: #0f1114; border: 1px solid #2b2f36; border-radius: 14px; padding: 16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Создать заявку</h1>
    <p class="muted">Заполните форму — карточка автоматически появится в таблице Briefs → cards, а ссылка на бриф отобразится ниже.</p>

    <form id="form" class="card">
      <div class="row">
        <div>
          <label>Тип задачи</label>
          <select id="taskType" required>
            <option value="">— Выберите —</option>
            <option>Съёмка</option>
            <option>Монтаж</option>
            <option>Стрим</option>
            <option>Дизайн</option>
            <option>Другое</option>
          </select>
        </div>
        <div>
          <label>Дедлайн</label>
          <input id="deadline" type="datetime-local" />
          <div class="hint">Можно оставить пустым</div>
        </div>
      </div>

      <div>
        <label>Ключевое сообщение / Краткое ТЗ</label>
        <textarea id="keyMessage" placeholder="Основная идея, что важно не потерять..."></textarea>
      </div>

      <div class="row">
        <div>
          <label>Ссылка на материалы (Google Drive и т.п.)</label>
          <input id="materialsLink" type="url" placeholder="https://..." />
        </div>
        <div>
          <label>Ссылка-источник / Референс</label>
          <input id="sourceLink" type="url" placeholder="https://..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Имя заявителя</label>
          <input id="requesterName" type="text" placeholder="Ваше имя" />
        </div>
        <div>
          <label>Telegram заявителя</label>
          <input id="requesterTelegram" type="text" placeholder="@username" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Email заявителя</label>
          <input id="requesterEmail" type="email" placeholder="you@example.com" />
        </div>
        <div>
          <label>Формат выдачи</label>
          <select id="outputOptions" multiple>
            <option value="file">Готовый файл</option>
            <option value="archive">Архив</option>
            <option value="yt">Загрузка на YouTube</option>
          </select>
          <div class="hint">Удерживайте Ctrl/Cmd, чтобы выбрать несколько.</div>
        </div>
      </div>

      <div class="row">
        <div class="switch">
          <input id="sendTelegram" type="checkbox" />
          <label for="sendTelegram">Отправить уведомление в Telegram</label>
        </div>
        <input id="telegramContact" type="text" placeholder="@username или ID чата (необязательно)" />
      </div>

      <div class="row">
        <div class="switch">
          <input id="sendEmail" type="checkbox" />
          <label for="sendEmail">Отправить уведомление на email</label>
        </div>
        <input id="emailContact" type="email" placeholder="email получателя (необязательно)" />
      </div>

      <div class="actions">
        <button id="submitBtn" class="primary" type="submit">Отправить заявку</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="result"></div>
    </form>
  </div>

  <script>
    // API URL подставлен:
    const API_URL = 'https://script.google.com/macros/s/AKfycbx0CuIfGvp8RTCvBOOp8IxbCfxzDyxmfHz9j8uiRCM7MJkd5tJAgfZtqoo7O2UHkJDUew/exec';

    const el = id => document.getElementById(id);
    const submitBtn = el('submitBtn');
    const statusEl = el('status');
    const resultEl = el('result');

    function getMultiSelectValues(select) {
      return [...select.options].filter(o => o.selected).map(o => o.value);
    }

    async function createRequest(e) {
      e.preventDefault();
      submitBtn.disabled = true;
      statusEl.textContent = 'Отправка...';
      resultEl.innerHTML = '';

      const payload = {
        action: 'create',
        data: {
          mode: 'request',
          status: 'request_new',
          taskType: el('taskType').value,
          deadline: el('deadline').value,
          outputOptions: getMultiSelectValues(el('outputOptions')),
          sendTelegram: el('sendTelegram').checked,
          telegramContact: el('telegramContact').value,
          sendEmail: el('sendEmail').checked,
          emailContact: el('emailContact').value,
          recordType: '',
          roles: {},
          sourceLink: el('sourceLink').value,
          keyMessage: el('keyMessage').value,
          materialsLink: el('materialsLink').value,
          approver: '',
          notes: '',
          requesterName: el('requesterName').value,
          requesterTelegram: el('requesterTelegram').value,
          requesterEmail: el('requesterEmail').value
        }
      };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Ошибка сервера');

        const briefUrl = json.briefUrl || (`./brief.html?id=${encodeURIComponent(json.id)}`);
        resultEl.innerHTML = `
          <div class="msg ok">
            Заявка отправлена. ID: <b>${json.id}</b><br/>
            <a href="${briefUrl}" target="_blank">Открыть карточку брифа</a>
          </div>
        `;
      } catch (err) {
        console.error(err);
        resultEl.innerHTML = `<div class="msg err">Не удалось отправить заявку: ${String(err.message || err)}</div>`;
      } finally {
        submitBtn.disabled = false;
        statusEl.textContent = '';
      }
    }

    document.getElementById('form').addEventListener('submit', createRequest);
  </script>
</body>
</html>
